<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Pantry</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    section { margin-bottom: 2rem; }
    button { margin-left: .5rem; }
    #group-switcher-modal, #recipe-modal, #scanner-container { display: none; }
  </style>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- Firebase setup ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM cache ---
    const dom = {
      userNameInput: document.getElementById('user-name-input'),
      saveNameBtn: document.getElementById('save-name-btn'),

      joinGroupBtn: document.getElementById('join-group-btn'),
      joinGroupIdInput: document.getElementById('join-group-id-input'),
      showCreateViewBtn: document.getElementById('show-create-view-btn'),
      newGroupIdDisplay: document.getElementById('new-group-id-display'),
      joinView: document.getElementById('join-view'),
      createView: document.getElementById('create-view'),
      copyIdBtn: document.getElementById('copy-id-btn'),
      joinNewGroupBtn: document.getElementById('join-new-group-btn'),

      switchGroupBtn: document.getElementById('switch-group-btn'),
      groupSwitcherModal: document.getElementById('group-switcher-modal'),
      closeSwitcherBtn: document.getElementById('close-switcher-btn'),
      joinAnotherGroupBtn: document.getElementById('join-another-group-btn'),
      joinAnotherGroupInput: document.getElementById('join-another-group-input'),
      createAnotherGroupBtn: document.getElementById('create-another-group-btn'),

      pantrySearch: document.getElementById('pantry-search'),
      shoppingSearch: document.getElementById('shopping-search'),
      pantryList: document.getElementById('pantry-list'),
      shoppingList: document.getElementById('shopping-list'),

      addPantryItemBtn: document.getElementById('add-pantry-item-btn'),
      pantryItemName: document.getElementById('pantry-item-name'),
      pantryItemQuantity: document.getElementById('pantry-item-quantity'),
      pantryItemUnit: document.getElementById('pantry-item-unit'),

      addShoppingItemBtn: document.getElementById('add-shopping-item-btn'),
      shoppingItemName: document.getElementById('shopping-item-name'),

      suggestRecipesBtn: document.getElementById('suggest-recipes-btn'),
      recipeModal: document.getElementById('recipe-modal'),
      closeRecipeModalBtn: document.getElementById('close-recipe-modal-btn'),

      scanPantryBtn: document.getElementById('scan-pantry-btn'),
      scanShoppingBtn: document.getElementById('scan-shopping-btn'),
      closeScannerBtn: document.getElementById('close-scanner-btn'),
      scannerContainer: document.getElementById('scanner-container')
    };

    // --- State ---
    const state = {
      userName: '',
      activeGroup: '',
      pantry: [],
      shopping: []
    };

    // --- Helpers ---
    const generateId = () => Math.random().toString(36).substring(2, 8);
    function showView(view) {
      if (view === 'group') {
        dom.joinView.style.display = 'block';
        dom.createView.style.display = 'none';
      }
    }
    function loadMainApp(groupId) {
      console.log("Loading group:", groupId);
    }
    function enterApp(groupId) {
      console.log("Entering group:", groupId);
      loadMainApp(groupId);
    }
    function handleItemAction(list, e) { console.log("Clicked", list, e.target); }
    function renderFilteredLists() { console.log("Filter triggered"); }
    function renderSavedGroups() { console.log("Render saved groups"); }
    function handleSuggestRecipes() { dom.recipeModal.style.display = "block"; }
    function startScanner(targetInput) { dom.scannerContainer.style.display = "block"; console.log("Start scanner for", targetInput); }
    function stopScanner() { dom.scannerContainer.style.display = "none"; }

    // --- Event listeners ---
    function init() {
      dom.saveNameBtn.addEventListener('click', () => {
        const userName = dom.userNameInput.value.trim();
        if (userName) {
          state.userName = userName;
          localStorage.setItem('pantryUserName', userName);
          loadMainApp(state.activeGroup);
        }
      });

      dom.joinGroupBtn.addEventListener('click', () => enterApp(dom.joinGroupIdInput.value.trim().toLowerCase()));
      dom.showCreateViewBtn.addEventListener('click', () => {
        dom.newGroupIdDisplay.textContent = generateId();
        dom.joinView.style.display = 'none';
        dom.createView.style.display = 'block';
      });

      dom.copyIdBtn.addEventListener('click', () => {
        const text = dom.newGroupIdDisplay.textContent;
        navigator.clipboard.writeText(text).then(() => {
          dom.copyIdBtn.textContent = 'Copied!';
          setTimeout(() => dom.copyIdBtn.textContent = 'Copy ID & Share', 2000);
        }).catch(() => alert('Could not copy text.'));
      });

      dom.joinNewGroupBtn.addEventListener('click', () => enterApp(dom.newGroupIdDisplay.textContent));
      dom.switchGroupBtn.addEventListener('click', () => { renderSavedGroups(); dom.groupSwitcherModal.style.display = 'block'; });
      dom.closeSwitcherBtn.addEventListener('click', () => dom.groupSwitcherModal.style.display = 'none');
      dom.joinAnotherGroupBtn.addEventListener('click', () => enterApp(dom.joinAnotherGroupInput.value.trim().toLowerCase()));
      dom.createAnotherGroupBtn.addEventListener('click', () => { dom.groupSwitcherModal.style.display = 'none'; showView('group'); dom.showCreateViewBtn.click(); });

      dom.pantrySearch.addEventListener('input', renderFilteredLists);
      dom.shoppingSearch.addEventListener('input', renderFilteredLists);

      dom.pantryList.addEventListener('click', (e) => handleItemAction('pantry', e));
      dom.shoppingList.addEventListener('click', (e) => handleItemAction('shopping', e));

      dom.addPantryItemBtn.addEventListener('click', async () => {
        const name = dom.pantryItemName.value.trim();
        if (!name) return;
        const quantity = parseInt(dom.pantryItemQuantity.value) || 1;
        const pantryRef = collection(db, `groups/${state.activeGroup}/pantry`);
        const existing = state.pantry.find(d => d.data().name.toLowerCase() === name.toLowerCase());
        if (existing) {
          await updateDoc(doc(pantryRef, existing.id), { 
            quantity: (existing.data().quantity || 0) + quantity, 
            addedBy: state.userName 
          });
        } else {
          await addDoc(pantryRef, { 
            name, 
            quantity, 
            unit: dom.pantryItemUnit.value.trim(), 
            addedBy: state.userName 
          });
        }
        dom.pantryItemName.value = dom.pantryItemQuantity.value = dom.pantryItemUnit.value = '';
      });

      dom.addShoppingItemBtn.addEventListener('click', async () => {
        const name = dom.shoppingItemName.value.trim();
        if (name && !state.shopping.find(d => d.data().name.toLowerCase() === name.toLowerCase())) {
          await addDoc(collection(db, `groups/${state.activeGroup}/shoppingList`), { name, addedBy: state.userName });
        }
        dom.shoppingItemName.value = '';
      });

      dom.closeRecipeModalBtn.addEventListener('click', () => dom.recipeModal.style.display = "none");
      dom.suggestRecipesBtn.addEventListener('click', handleSuggestRecipes);

      dom.scanPantryBtn.addEventListener('click', () => startScanner(dom.pantryItemName));
      dom.scanShoppingBtn.addEventListener('click', () => startScanner(dom.shoppingItemName));
      dom.closeScannerBtn.addEventListener('click', stopScanner);

      // Enter key submits for inputs
      [dom.pantryItemName, dom.pantryItemQuantity, dom.pantryItemUnit].forEach(el => {
        el.addEventListener('keypress', e => { if (e.key === 'Enter') dom.addPantryItemBtn.click(); });
      });
      dom.shoppingItemName.addEventListener('keypress', e => { if (e.key === 'Enter') dom.addShoppingItemBtn.click(); });

      onAuthStateChanged(auth, user => {
        if (user) {
          if (state.activeGroup) enterApp(state.activeGroup);
          else showView('group');
        } else {
          signInAnonymously(auth).catch(err => console.error("Sign in failed:", err));
        }
      });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <h1>Smart Pantry</h1>

  <section id="user-section">
    <input id="user-name-input" placeholder="Your name">
    <button id="save-name-btn">Save Name</button>
  </section>

  <section id="group-section">
    <div id="join-view">
      <input id="join-group-id-input" placeholder="Enter Group ID">
      <button id="join-group-btn">Join Group</button>
      <button id="show-create-view-btn">Create New Group</button>
    </div>
    <div id="create-view">
      <p>Your Group ID: <span id="new-group-id-display"></span></p>
      <button id="copy-id-btn">Copy ID & Share</button>
      <button id="join-new-group-btn">Join</button>
    </div>
  </section>

  <section>
    <h2>Pantry</h2>
    <input id="pantry-search" placeholder="Search pantry">
    <div id="pantry-list"></div>
    <input id="pantry-item-name" placeholder="Item name">
    <input id="pantry-item-quantity" type="number" placeholder="Qty">
    <input id="pantry-item-unit" placeholder="Unit">
    <button id="add-pantry-item-btn">Add Pantry Item</button>
    <button id="scan-pantry-btn">Scan Pantry Item</button>
  </section>

  <section>
    <h2>Shopping List</h2>
    <input id="shopping-search" placeholder="Search shopping list">
    <div id="shopping-list"></div>
    <input id="shopping-item-name" placeholder="Item name">
    <button id="add-shopping-item-btn">Add Shopping Item</button>
    <button id="scan-shopping-btn">Scan Shopping Item</button>
  </section>

  <section>
    <button id="suggest-recipes-btn">Suggest Recipes</button>
  </section>

  <!-- Modals -->
  <div id="group-switcher-modal">
    <button id="close-switcher-btn">Close</button>
    <input id="join-another-group-input" placeholder="Group ID">
    <button id="join-another-group-btn">Join Another Group</button>
    <button id="create-another-group-btn">Create New Group</button>
  </div>

  <div id="recipe-modal">
    <button id="close-recipe-modal-btn">Close</button>
    <div id="recipes-container"></div>
  </div>

  <div id="scanner-container">
    <button id="close-scanner-btn">Close Scanner</button>
  </div>
</body>
</html>
